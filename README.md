# Psilocybin_NVC_Manuscript

Repository for documentation, code, and smaller datasets associated with the SN-lab manuscript on psilocybin-induced changes in mouse NVC. Each section below details the contents of a folder containing processed data tables and/or code for analyzing and plotting the data within those tables.

## Two-photon (2P) Imaging Analysis

This folder contains data tables of processed (not raw) neuron and vessel data obtained from 2-photon line scan imaging; all vessel data (containing flow velocity and width for all recorded vessels) are stored in long data format in the "vessel_long_vector.mat file, and all neuron calcium imaging data in the "neuron_long_vector.mat file. This folder also contains a script (Analyze2PLinescans.m)  to process intermediate imaging data to generate these data tables and plot the data.

To generate the processed imaging data from raw Scanimage arbitrary linescan data, the data is first processed through the "arbitraryLinescanPreprocessing.m" script in the  [sn-lab/Blood-flow](https://github.com/sn-lab/Blood-flow) repository. This script linearizes all neuron cell body line ROIs (ROI #s 2, 3, 6, 7, 10, 11) drawn in Scanimage, preprocesses all down-vessel line ROIs (#s 1, 5, 9) for later calculation of blood flow velocity, and estimates vessel widths of cross-vessel line ROIs (#s 4, 8, 12). For calculation of vessel width, the script generates a pop-up window asking the user to drag lines to the approximate average top and bottom vessel edge to create an initial estimate of vessel diameter, after which a Gaussian function is fit to the cross-section profile to estimate the vessel width for every frame individually. This vector of vessel widths is saved in a "results.mat" file. For calculation of blood flow velocity, the script outputs a results window display the line scan rate (in Hz) as well as the pixel/micron conversion of the linearized down-vessel line scans. These linearized down-vessel line scans are next processed with the "extractVelTiffShared.m" script in the [sn-lab/Blood-flow](https://github.com/sn-lab/Blood-flow) repository, which requires user input for the line scan rate and pixel/micron conversion factor. The resulting vector of blood flow velocities is saved in a "...rawVel...mat" file.

Lastly, to analyze and plot capillary width from 2P frame scan imaging volumes, procesed (not raw) data, the "Analyze2PCapillaryWidths.m" Matlab script is used. To generate the processed vessel width data from 2P frame scans, the "[getVesselWidths](https://github.com/sn-lab/Vessel-Diameter-Tools/blob/main/getVesselWidths.mlapp "getVesselWidths.mlapp")" Matlab app (located in the [sn-lab/Vessel-Diameter-Tools](https://github.com/sn-lab/Vessel-Diameter-Tools) repository) is used so that the user can manually draw 4-point boxes around multiple capillary segments. The app then fits a Gaussian function to the average cross-section profile of each vessel segment and outputs a "CapillaryVesselWidths.mat" file for each imaging plane processed.

## Widefield Imaging Analysis

This folder contains data tables of processed (not raw) multimodal data obtained from widefield multimodal imaging. all vessel data (containing flow velocity and width for all recorded vessels) are stored in long data format in the "vessel_long_vector.mat file, and all neuron calcium imaging data in the "neuron_long_vector.mat file. This folder also contains a script (AnalyzeWidefieldVideos.m) to process intermediate (not raw) imaging data to generate these data tables and plot the data. This script loads all intermediate imaging data, generates binary masks around parenchyma regions (with user-customizable binarization settings) and already-drawn vessel boxes around arteriole and venule segments, calculates average multimodal imaging values (e.g. ICT, HbT) within each ROI type, and organizes all of these variables for all datasets in long data format,. This data is saved as "all_long_vectors.mat". This data is then further processed to calculate the mean values during rise/recovery/response times as appropriate for the data type (and as described in the manuscript), and the data is analyzed and plotted. 

To create the manually-drawn vessel boxes around arteriole and venule segments, the "[getVesselWidths](https://github.com/sn-lab/Vessel-Diameter-Tools/blob/main/getVesselWidths.mlapp "getVesselWidths.mlapp")" Matlab app (located in the [sn-lab/Vessel-Diameter-Tools](https://github.com/sn-lab/Vessel-Diameter-Tools) repository) is used on the oxygenation map for each dataset individually so that the user can manually draw 4-point boxes around arteriold and venule segments. This "AnalyzeWidefieldVideos" script then calls the "vesselWidthTimeseries" function to fit a Gaussian function to the average cross-section profile of each vessel segment.

To generate the processed imaging data from raw multimodal imaging data, the data is first processed through the "MultiStimVideos.m" script. This script loads the raw multimodal imaging data (.tif and .mat files) and processes the data in multiple ways: filtering; temporal alignment to the stimuli; calculation of Speckl/ICT/Hemiglobin/etc. information from raw imaging channels; saving the trial-averaged stimulus-response video of each datatype; saving an oxygenation reference map to for manually drawing vessel boxes around arteriole/venule segments.



## BOLD Simulations

The code used to simulate single-node and whole-brain neural mass model activity, blood flow, and BOLD were modifed based on the [neurolib repository](https://neurolib-dev.github.io/). After installing neurolib based on the instructions in that library, four files were manually modified to enable custom adjustments of Balloon-Windkessel NVC model parameters. The files which were modified can be found in the [neurolib/neurolib/models](https://github.com/neurolib-dev/neurolib/tree/master/neurolib/models) folder of the original repository and the "aln" and "bold" subfolders within that directory. The modified files are contained in this "Bold Simulations folder, in the "custom files" subfolder.

**To perform whole-brain simulations:** After the neurlib library was installed and the relevent files were replaced with the modified files, simulations were performed using the "bold_sim.py" script in python. This script contains three code sections for running BOLD simulations. In the "run_example" section, a single whole-brain simulation is performed, and the resulting neural activity data, BOLD data, and functional connectivity (FC) matrix is saved. In the run_series section, a set of simulations is performed under identical NVC parameters but with different random seeds to initiate the model with different neural activity patterns, and the resulting FC matrix is saved for each. In the "run_matrix" section, a set of simulations are repeated across a matrix of "Gamma" and "K" NVC parameters values, and the global FC strength of each simulation is saved. To plot the resulting data from these simulations, the script "analyze_bold_80nodes.m" was run in Matlab.

**To perform single-node simulations:** The Balloon-Windkessel model from neurolib was translated for Matlab for both simulation and parameter fitting with a square-wave neural activity input. The "integrateBOLD" function was used to simulate the flow and BOLD signals from a square wave activity input. The "fitBOLD" function was used to fit measured vessel flow responses (stored in the "vel_avgs_2p.mat" and "speed_avgs_widefield.mat" files) to a simulated flow response from optimized NVC parameters. All of these single-node simulation functions were called, and all plots were generated, from the "analyze_bold_1node.m" script.
